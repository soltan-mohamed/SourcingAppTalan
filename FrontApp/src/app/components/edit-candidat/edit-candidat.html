<div class="form-container">
    
    <!-- Header -->
    <div class="header-section">
        <h2 class="header-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit Candidate
        </h2>
        <button class="close-button" (click)="onClose()">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <div class="content-section">
        <form [formGroup]="CandidateForm" (ngSubmit)="onSubmit()" class="form-content">

            <!-- Progress indicator -->
            <div class="progress-container">
                <div class="progress-track">
                    <div class="progress-fill" [style.width]="getFormProgress() + '%'"></div>
                </div>
            </div>

            <!-- Name fields -->
            <div class="form-row">
                <!-- Last name Field -->
                <div class="form-group">
                    <label for="nom" class="form-label">
                        Last name<span class="text-red-500">*</span>
                    </label>
                    <input 
                        id="nom"
                        type="text"
                        formControlName="nom"
                        placeholder="Enter last name"
                        class="form-input"
                        [class.error]="CandidateForm.get('nom')?.invalid && CandidateForm.get('nom')?.touched"
                    >
                    <p *ngIf="CandidateForm.get('nom')?.invalid && CandidateForm.get('nom')?.touched" 
                        class="error-message">
                        <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Please provide the last name of the candidate
                    </p>
                </div>

                <!-- First name Field -->
                <div class="form-group">
                    <label for="prenom" class="form-label">
                        First name<span class="text-red-500">*</span>
                    </label>
                    <input 
                        id="prenom"
                        type="text"
                        formControlName="prenom"
                        placeholder="Enter first name"
                        class="form-input"
                        [class.error]="CandidateForm.get('prenom')?.invalid && CandidateForm.get('prenom')?.touched"
                    >
                    <p *ngIf="CandidateForm.get('prenom')?.invalid && CandidateForm.get('prenom')?.touched" 
                        class="error-message">
                        <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Please provide the first name of the candidate
                    </p>
                </div>
            </div>

            <!-- Status display -->
            <div class="status-container" [ngSwitch]="data['statut']">
                <span class="status-label">Latest status:</span>
                <div *ngSwitchCase="'ACCEPTED'">
                    <span class="status-badge accepted">{{ data['statut'] | lowercase }}</span>
                </div>
                <div *ngSwitchCase="'REJECTED'">
                    <span class="status-badge rejected">{{ data['statut'] | lowercase }}</span>
                </div>
                <div *ngSwitchCase="'SCHEDULED'">
                    <span class="status-badge scheduled">{{ data['statut'] | lowercase }}</span>
                </div>
                <div *ngSwitchCase="'VIVIER'">
                    <span class="status-badge vivier">{{ data['statut'] | lowercase }}</span>
                </div>
                <div *ngSwitchCase="'CONTACTED'">
                    <span class="status-badge contacted">{{ data['statut'] | lowercase }}</span>
                </div>
            </div>
            
            <!-- Phone number Field -->
            <div class="form-group">
                <label for="telephone" class="form-label">
                    Phone number<span class="text-red-500">*</span>
                </label>
                <input 
                    id="telephone"
                    type="text"
                    formControlName="telephone"
                    placeholder="Enter phone number of candidate"
                    class="form-input"
                    [class.error]="CandidateForm.get('telephone')?.invalid && CandidateForm.get('telephone')?.touched"
                >
                <p *ngIf="CandidateForm.get('telephone')?.invalid && CandidateForm.get('telephone')?.touched" 
                    class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Please provide a correct phone number
                </p>
            </div>

            <!-- Email Field -->
            <div class="form-group">
                <label for="email" class="form-label">
                    Email address<span class="text-red-500">*</span>
                </label>
                <input 
                    id="email"
                    type="text"
                    formControlName="email"
                    placeholder="Enter email address"
                    class="form-input"
                    [class.error]="CandidateForm.get('email')?.invalid && CandidateForm.get('email')?.touched"
                >
                <p *ngIf="CandidateForm.get('email')?.invalid && CandidateForm.get('email')?.touched" 
                    class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Please provide a correct address
                </p>
            </div>
              <!-- === NEW: Position Field === -->
            <!-- ============================================= -->
            <div *ngIf = "(this.CandidateForm.get('position')?.pristine && this.CandidateForm.get('position')?.value !== '') || this.CandidateForm.get('position')?.dirty" class="form-group">
                <label for="" class="form-label">
                    Position<span class="text-red-500">*</span>
                </label>
                <input 
                    id="position"
                    type="text"
                    formControlName="position"
                    placeholder="Enter the position"
                    class="form-input"
                    [class.error]="this.CandidateForm.get('position')?.touched && this.CandidateForm.get('position')?.value === ''"
                >
                <p *ngIf="this.CandidateForm.get('position')?.touched && this.CandidateForm.get('position')?.value === ''" 
                    class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Please provide the position for this recruitment.
                </p>
            </div>

            <!-- Hiring Date Field -->
            <div class="form-group">
                <label for="hiringDate" class="form-label">
                    Hiring Date <span style="color: #6c757d;">(Optional)</span>
                </label>
                <input 
                    id="hiringDate"
                    type="date"
                    formControlName="hiringDate"
                    class="form-input"
                    (change)="CandidateForm.updateValueAndValidity()"
                >
                <div style="margin-top: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                    <p style="font-size: 0.75rem; color: #6c757d; margin: 0; display: flex; align-items: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Leave empty if the candidate has no previous work experience
                    </p>
                    <button 
                        type="button" 
                        *ngIf="hasHiringDate()"
                        (click)="CandidateForm.get('hiringDate')?.setValue(''); CandidateForm.updateValueAndValidity()"
                        style="font-size: 0.75rem; color: #f44336; text-decoration: underline; background: transparent; border: none; cursor: pointer;"
                    >
                        Clear date
                    </button>
                </div>
            </div>

            <!-- Experience Period Preview -->
            <div class="experience-preview">
                <div class="preview-content">
                    <div class="preview-info">
                        <svg xmlns="http://www.w3.org/2000/svg" class="preview-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="preview-label">Experience will be:</span>
                        <span class="preview-value">{{ getExperiencePreview() }}</span>
                    </div>
                    <div *ngIf="!hasHiringDate()" class="preview-note">
                        No hiring date = 0-1 year
                    </div>
                </div>
                <div *ngIf="data.experiencePeriod && data.experiencePeriod !== getExperiencePreview()" class="preview-comparison">
                    <span class="current-value">Current:</span> {{ data.experiencePeriod }} â†’ 
                    <span class="new-value">Will become:</span> {{ getExperiencePreview() }}
                </div>
            </div>

            <!-- Responsible Information -->
            <div class="responsible-section">
                <div class="section-header">
                    <h3 class="section-title">Responsible Information</h3>
                </div>
            
                <div class="responsible-container">
                    <div class="responsible-item">
                        <div class="avatar">
                            {{getInitials(data['responsable']['fullName'])}}
                        </div>
                        <div class="responsible-info">
                            <p class="responsible-name">{{data['responsable']['fullName']}}</p>
                            <p class="responsible-role">Primary responsible</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Skills -->
            <div class="skills-section">
                <div class="form-group">
                    <label for="keywords" class="form-label">
                        Skills
                    </label>
                    <div class="skills-input-container">
                        <input 
                            id="keywords"
                            type="text" 
                            placeholder="Add up to 5 keywords (press Enter to add)"
                            class="skills-input"
                            #keywordInput
                            (keydown.enter)="addKeyword(keywordInput.value); keywordInput.value = ''; $event.preventDefault()"
                        >
                        <button 
                            type="button"
                            class="add-button"
                            (click)="addKeyword(keywordInput.value); keywordInput.value = ''"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="add-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                    </div>
                    <div *ngIf="keywords.length > 0" class="chips-container">
                        <mat-chip-grid #chipGrid aria-label="Enter skill">
                            @for (keyword of keywords; track keyword) {
                            <mat-chip-row
                                (removed)="removeKeyword(keyword)"
                                [editable]="true"
                                [aria-description]="'press enter to edit ' + keyword"
                            >
                                {{keyword}}
                                <button matChipRemove [attr.aria-label]="'remove ' + keyword">
                                    <mat-icon>cancel</mat-icon>
                                </button>
                            </mat-chip-row>
                            }
                        </mat-chip-grid>
                    </div>
                </div>
            </div>
            
            <!-- CV File Upload -->
            <div class="file-upload-section">
                <h3 class="section-title">CV PDF</h3>
                <div 
                    class="upload-container"
                    [class.dragging]="isDragging"
                    [class.has-file]="selectedFile && !fileError"
                    [class.error]="fileError"


                >
                    @if (!selectedFile) {
                    <div class="upload-placeholder"
                        (click)="fileInput.click()"
                        (dragover)="onDragOver($event)"
                        (dragleave)="onDragLeave($event)"
                        (drop)="onDrop($event)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="upload-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="upload-title">Upload the CV PDF file</p>
                        <p class="upload-subtitle">Drag and drop the CV here, or click to browse</p>
                        <p class="upload-note">Maximum file size: 10MB</p>
                    </div>
                    } @else {
                    <div class="file-preview" (click)="openCvFile()">
                        <div class="file-icon-container">
                            <svg xmlns="http://www.w3.org/2000/svg" class="file-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="file-info">
                            <span class="file-name">{{ selectedFile!.name }}</span>
                            <span class="file-size">{{ formatFileSize(selectedFile!.size) }}</span>
                            <button 
                                type="button"
                                class="remove-button"
                                (click)="removeFile(); $event.stopPropagation()"
                            >
                                Remove File
                            </button>
                        </div>
                    </div>
                    }
                    
                    @if (fileError) {
                    <p class="error-message">
                        <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        {{ fileErrorMessage }}
                    </p>
                    }
                </div>
                
                <input 
                    #fileInput 
                    type="file" 
                    accept="application/pdf" 
                    class="file-input" 
                    (change)="onFileSelected($event)"
                >
            </div>
            
            <div class="actions-section">
                <button 
                    type="button" 
                    class="action-button secondary"
                    (click)="closeForm()"
                >
                    Cancel
                </button>
                <button 
                    type="submit" 
                    class="action-button primary"
                    [disabled]="CandidateForm.invalid || isSubmitting || this.CandidateForm.get('position')?.touched && this.CandidateForm.get('position')?.value === '' "
                >
                    <span *ngIf="!isSubmitting">Update</span>
                    <span *ngIf="isSubmitting">
                        <svg class="loading-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>